name: AHM flow (all steps)

on:
  workflow_dispatch:
    inputs:
      # sudo-key:
      #   description: "Sudo key to use as override (optional, default is //Alice)"
      #   required: false
      network:
        description: "Network to use (ALL means Polkadot and Kusama)"
        default: "polkadot"
        type: choice
        options:
          - ALL
          - kusama
          - polkadot
      rc_runtime_override_url:
        description: "Url to download the RC runtime to override (e.g https://some-server.com/kusama_runtime-v1009000.compact.compressed_processed.wasm)"
        required: false
        type: string
        default: ""
      ah_runtime_override_url:
        description: "Url to download the AH runtime to override (e.g https://some-server.com/asset-hub-kusama_runtime-v1009000.compact.compressed_processed.wasm)"
        required: false
        type: string
        default: ""
      pre_db_run_id:
        description: "Run ID to Start the process from a pre-db from a previous run"
        required: false
        type: string
        default: ""
      post_db_url:
        description: "Url for download a post-db and start from there"
        required: false
        type: string
        default: ""
      doppelganger_version:
        description: "Tag of the release to use"
        required: false
        type: string
        default: "latest"
      runner:
        description: "Runner to run the jobs"
        required: false
        type: string
        default: "parity-large-persistent-test"
      concurrency-suffix:
        description: "Extra suffix for the concurrency group"
        type: string
        required: false
        default: "-mygroup"
      ah-extra-args:
        description: "Override ZOMBIE_BITE_AH_EXTRA_ARGS"
        type: string
        required: false
        default: ""
      rc-extra-args:
        description: "Override ZOMBIE_BITE_RC_EXTRA_ARGS"
        type: string
        required: false
        default: ""
  schedule:
    - cron: "0 0,8,16 * * *" # Every 8 hrs for Polkadot

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-${{ inputs.runner }}-${{ inputs.concurrency-suffix}}
  cancel-in-progress: true

permissions: {}

jobs:
  zombie_bite_polkadot:
    # run by schedule or by demand
    if: ${{ inputs.network == 'ALL' || inputs.network == 'polkadot' || github.event.schedule == '0 0 * * *' }}
    uses: ./.github/workflows/zombie-bite-common.yml
    with:
      network: polkadot
      sudo-key: ${{ inputs.sudo-key }}
      rc_runtime_override_url: ${{ inputs.rc_runtime_override_url }}
      ah_runtime_override_url: ${{ inputs.ah_runtime_override_url }}
      runner: ${{ inputs.runner || 'parity-large-persistent-test'}}
      doppelganger_version: ${{ inputs.doppelganger_version }}
      pre_db_run_id: ${{ inputs.pre_db_run_id }}
      post_db_url: ${{ inputs.post_db_url }}
      ah_extra_args: ${{ inputs.ah-extra-args }}
      rc_extra_args: ${{ inputs.rc-extra-args }}

  zombie_bite_kusama:
    # run by demand
    if: ${{ inputs.network == 'ALL' || inputs.network == 'kusama' }}
    uses: ./.github/workflows/zombie-bite-common.yml
    with:
      network: kusama
      sudo-key: ${{ inputs.sudo-key }}
      rc_runtime_override_url: ${{ inputs.rc_runtime_override_url }}
      ah_runtime_override_url: ${{ inputs.ah_runtime_override_url }}
      runner: parity-large-persistent-test
